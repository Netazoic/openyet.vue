-- jh_global_timeseries  CREATE combined recordsINSERT INTO combined(sourcecode,state,country,date,confirmed)SELECT DISTINCT'JH_GLOBAL_CONF' as sourcecode,state,country,date,CASE 	WHEN ct = 0 THEN null	ELSE ctEND as confirmedFROM jh_timeseriesWHERE 1 = 1AND type = 'C'AND date > '{{lastUpdate}}';/*UPDATE combinedSET confirmed = v1.ctFROM( SELECT * FROM jh_timeseriesWHERE type = 'C') AS v1WHERE (combined.state = v1.state OR (combined.state is null AND v1.state is null))AND combined.country = v1.countryAND combined.date = v1.date;*/UPDATE combinedSET death = v1.ctNonZeroFROM( SELECT *,	CASE 		WHEN ct = 0 THEN null		ELSE ct	END as ctNonZero	FROM jh_timeseries	WHERE type = 'D') AS v1WHERE (combined.state = v1.state OR (combined.state is null AND v1.state is null))AND combined.country = v1.countryAND combined.date = v1.date;UPDATE combinedSET recovered = v1.ctNonZeroFROM( SELECT *, 	CASE		WHEN ct = 0 THEN null		ELSE ct	END as ctNonZero	FROM jh_timeseries	WHERE type = 'R') AS v1WHERE (combined.state = v1.state OR (combined.state is null AND v1.state is null))AND combined.country = v1.countryAND combined.date = v1.date;-- Create national rollups for countries that report by stateINSERT INTO combined(sourcecode,state,country,date,confirmed)SELECT DISTINCT'JH_GLOBAL_CONF' as sourcecode,null as state,country,date,CASE 	WHEN sum(ct) = 0 THEN null	ELSE sum(ct)END as confirmedFROM jh_timeseriesWHERE 1 = 1AND state is not nullAND type = 'C'AND date > '{{lastUpdate}}'AND country not in ('France','Netherlands','United Kingdom','Denmark') -- don't use data for countries that separately report colonial territories as statesGROUP BY country,date;UPDATE combinedSET death = v1.ctNonZeroFROM( SELECT country,null as state,date,	CASE 		WHEN sum(ct) = 0 THEN null		ELSE sum(ct)	END as ctNonZero	FROM jh_timeseries	WHERE type = 'D'	AND date > '{{lastUpdate}}'	AND state is not null	GROUP BY country,date) AS v1WHERE (combined.state is null AND v1.state is null)AND combined.country = v1.countryAND combined.country not in ('France','Netherlands','United Kingdom','Denmark') -- don't use data for countries that separately report colonial territories as statesAND combined.date = v1.date;UPDATE combinedSET recovered = v1.ctNonZeroFROM( SELECT country,null as state,date,	CASE 		WHEN sum(ct) = 0 THEN null		ELSE sum(ct)	END as ctNonZero	FROM jh_timeseries	WHERE type = 'R'	AND date > '{{lastUpdate}}'	AND state is not null	GROUP BY country,date) AS v1WHERE (combined.state is null AND v1.state is null)AND combined.country = v1.countryAND combined.country not in ('France','Netherlands','United Kingdom','Denmark') -- don't use data for countries that separately report colonial territories as statesAND combined.date = v1.date;